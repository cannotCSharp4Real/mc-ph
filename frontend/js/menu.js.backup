class MenuPage {
    constructor() {
        this.currentUser = null;
        this.cart = this.loadCart();
        this.products = [];
         async loadProducts() {
        try {
            this.showLoading();
            const response = await fetch('/api/products');
            
            if (!response.ok) {
                throw new Error('Failed to load products');
            }
            
            this.products = await response.json();
            this.filteredProducts = [...this.products];
            console.log('Products loaded:', this.products.length);
            console.log('First product:', this.products[0]);
            this.renderProducts();
            
        } catch (error) {
            console.error('Error loading products:', error);
            this.showError('Failed to load menu items. Please try again.');
        }
    }oducts = [];
        this.categories = [];
        this.selectedCategory = 'all';
        this.searchQuery = '';
        this.selectedProduct = null;
        this.selectedSize = null;
        this.selectedAddons = [];
        this.quantity = 1;
        this.totalPrice = 0;
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.loadCurrentUser();
        this.loadProducts();
        this.updateCartDisplay();
        this.createNotificationElement();
    }

    setupEventListeners() {
        // Search functionality
        const searchInput = document.querySelector('#menu-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.searchQuery = e.target.value.toLowerCase();
                this.filterProducts();
            });
        }

        // Close modal
        const closeBtn = document.querySelector('.close-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.closeModal());
        }

        // Modal overlay click
        const modalOverlay = document.querySelector('#customizationModal');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    this.closeModal();
                }
            });
        }

        // Quantity controls
        const quantityMinusBtn = document.querySelector('.quantity-minus');
        const quantityPlusBtn = document.querySelector('.quantity-plus');
        
        if (quantityMinusBtn) {
            quantityMinusBtn.addEventListener('click', () => this.updateQuantity(-1));
        }
        
        if (quantityPlusBtn) {
            quantityPlusBtn.addEventListener('click', () => this.updateQuantity(1));
        }

        // Add to cart button
        const addToCartBtn = document.querySelector('.add-to-cart-btn');
        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', () => this.addToCart());
        }

        // ESC key to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeModal();
            }
        });
    }

    loadCurrentUser() {
        const token = localStorage.getItem('authToken');
        if (token) {
            try {
                const decodedToken = JSON.parse(atob(token.split('.')[1]));
                this.currentUser = decodedToken;
            } catch (error) {
                console.error('Error decoding token:', error);
                localStorage.removeItem('authToken');
            }
        }
        this.updateNavigationHeader();
    }

    updateNavigationHeader() {
        const navRight = document.querySelector('.nav-right');
        if (!navRight) return;

        if (this.currentUser) {
            // Customer navigation
            navRight.innerHTML = `
                <div class="nav-item">
                    <a href="cart.html" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count">${this.getCartItemCount()}</span>
                    </a>
                </div>
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" onclick="toggleDropdown()">
                        <i class="fas fa-user"></i>
                    </a>
                    <div class="dropdown-menu" id="dropdown-menu">
                        <a href="profile.html" class="dropdown-item">
                            <i class="fas fa-user-circle"></i>
                            Profile
                        </a>
                        <a href="orders.html" class="dropdown-item">
                            <i class="fas fa-receipt"></i>
                            Orders
                        </a>
                        <a href="#" class="dropdown-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </a>
                    </div>
                </div>
            `;
        } else {
            // Guest navigation
            navRight.innerHTML = `
                <div class="nav-item">
                    <a href="cart.html" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="cart-count">${this.getCartItemCount()}</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="auth.html" class="nav-link">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </a>
                </div>
            `;
        }
    }

    async loadProducts() {
        try {
            this.showLoading();
            const response = await fetch('/api/products');
            
            if (!response.ok) {
                throw new Error('Failed to load products');
            }
            
            this.products = await response.json();
            this.filteredProducts = [...this.products];
            console.log('Products loaded:', this.products.length);
            console.log('First product:', this.products[0]);
            
            // Load categories after products are loaded
            this.loadCategories();
            this.renderProducts();
            
        } catch (error) {
            console.error('Error loading products:', error);
            this.showError('Failed to load products. Please try again.');
        }
    }

    loadCategories() {
        try {
            // Extract unique categories from products
            const uniqueCategories = [...new Set(this.products.map(product => product.category))];
            this.categories = [
                { id: 'all', name: 'All Items', icon: 'fas fa-th-large' },
                ...uniqueCategories.map(cat => ({
                    id: cat.toLowerCase().replace(/\s+/g, '-'),
                    name: cat,
                    icon: this.getCategoryIcon(cat)
                }))
            ];
            
            this.renderCategories();
            
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    getCategoryIcon(category) {
        const iconMap = {
            'Hot Coffee': 'fas fa-mug-hot',
            'Cold Coffee': 'fas fa-snowflake',
            'Tea': 'fas fa-leaf',
            'Pastries': 'fas fa-birthday-cake',
            'Sandwiches': 'fas fa-bread-slice',
            'Salads': 'fas fa-seedling',
            'Beverages': 'fas fa-glass-whiskey',
            'Desserts': 'fas fa-ice-cream'
        };
        return iconMap[category] || 'fas fa-utensils';
    }

    renderCategories() {
        const categoryList = document.querySelector('#category-list');
        if (!categoryList) return;

        categoryList.innerHTML = this.categories.map(category => `
            <button 
                class="category-btn ${this.selectedCategory === category.id ? 'active' : ''}" 
                data-category-id="${category.id}"
            >
                <i class="${category.icon}"></i>
                <span>${category.name}</span>
            </button>
        `).join('');

        // Add event listeners to category buttons
        categoryList.querySelectorAll('.category-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const categoryId = e.target.closest('.category-btn').getAttribute('data-category-id');
                this.filterByCategory(categoryId);
            });
        });
    }

    filterByCategory(categoryId) {
        this.selectedCategory = categoryId;
        this.filterProducts();
        this.renderCategories(); // Re-render to update active state
    }

    filterProducts() {
        this.filteredProducts = this.products.filter(product => {
            const matchesCategory = this.selectedCategory === 'all' || 
                                  product.category.toLowerCase().replace(/\s+/g, '-') === this.selectedCategory;
            const matchesSearch = product.name.toLowerCase().includes(this.searchQuery) ||
                                product.description.toLowerCase().includes(this.searchQuery) ||
                                product.category.toLowerCase().includes(this.searchQuery);
            
            return matchesCategory && matchesSearch;
        });
        
        this.renderProducts();
    }

    renderProducts() {
        const menuGrid = document.querySelector('#menu-grid');
        if (!menuGrid) return;

        if (this.filteredProducts.length === 0) {
            if (this.searchQuery) {
                this.showNoResults();
            } else {
                menuGrid.innerHTML = '<div class="no-results-state"><p>No products available.</p></div>';
            }
            return;
        }

        menuGrid.innerHTML = this.filteredProducts.map(product => `
            <div class="menu-item">
                <div class="menu-item-image">
                    ${product.image ? 
                        `<img src="${product.image}" alt="${product.name}">` : 
                        '<i class="fas fa-coffee"></i>'
                    }
                </div>
                <div class="menu-item-content">
                    <div class="menu-item-category">${product.category}</div>
                    <h3 class="menu-item-name">${product.name}</h3>
                    <p class="menu-item-description">${product.description}</p>
                    <div class="menu-item-footer">
                        <div class="menu-item-price">₱${product.price.toFixed(2)}</div>
                        <button class="add-to-cart-btn-mini" data-product-id="${product._id}">
                            Add to Cart
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        // Add event listeners to all add to cart buttons
        menuGrid.querySelectorAll('.add-to-cart-btn-mini').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const productId = e.target.getAttribute('data-product-id');
                console.log('Button clicked, product ID:', productId);
                this.openCustomizationModal(productId);
            });
        });
    }

    showLoading() {
        const menuGrid = document.querySelector('#menu-grid');
        if (menuGrid) {
            menuGrid.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading menu items...</p>
                </div>
            `;
        }
    }

    showError(message) {
        const menuGrid = document.querySelector('#menu-grid');
        if (menuGrid) {
            menuGrid.innerHTML = `
                <div class="error-state">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <p>${message}</p>
                    <button class="retry-btn" onclick="menuPage.loadProducts()">
                        <i class="fas fa-redo"></i>
                        Try Again
                    </button>
                </div>
            `;
        }
    }

    showNoResults() {
        const menuGrid = document.querySelector('#menu-grid');
        if (menuGrid) {
            menuGrid.innerHTML = `
                <div class="no-results-state">
                    <div class="no-results-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <p>No items found for "${this.searchQuery}"</p>
                    <button class="retry-btn" onclick="menuPage.clearSearch()">
                        <i class="fas fa-times"></i>
                        Clear Search
                    </button>
                </div>
            `;
        }
    }

    clearSearch() {
        const searchInput = document.querySelector('#menu-search');
        if (searchInput) {
            searchInput.value = '';
        }
        this.searchQuery = '';
        this.filterProducts();
    }

    openCustomizationModal(productId) {
        console.log('Opening modal for product:', productId);
        this.selectedProduct = this.products.find(p => p._id === productId);
        console.log('Selected product:', this.selectedProduct);
        
        if (!this.selectedProduct) {
            console.error('Product not found:', productId);
            return;
        }

        this.selectedSize = null;
        this.selectedAddons = [];
        this.quantity = 1;
        
        this.renderModal();
        this.showModal();
    }

    renderModal() {
        const modalTitle = document.querySelector('.modal-header h2');
        const productImage = document.querySelector('.product-image');
        const productDescription = document.querySelector('.product-description');
        const productPrice = document.querySelector('.product-price');
        const sizeOptions = document.querySelector('.size-options');
        const addonOptions = document.querySelector('.addon-options');
        const quantityDisplay = document.querySelector('.quantity-display');
        const totalPrice = document.querySelector('.total-price');

        if (modalTitle) modalTitle.textContent = this.selectedProduct.name;
        
        if (productImage) {
            productImage.innerHTML = this.selectedProduct.image ?
                `<img src="${this.selectedProduct.image}" alt="${this.selectedProduct.name}">` :
                '<i class="fas fa-coffee"></i>';
        }
        
        if (productDescription) productDescription.textContent = this.selectedProduct.description;
        if (productPrice) productPrice.textContent = `₱${this.selectedProduct.price.toFixed(2)}`;

        // Render size options
        if (sizeOptions && this.selectedProduct.sizes) {
            sizeOptions.innerHTML = this.selectedProduct.sizes.map(size => `
                <div class="size-option">
                    <input 
                        type="radio" 
                        name="size" 
                        value="${size.name}" 
                        id="size-${size.name}"
                        onchange="menuPage.selectSize('${size.name}', ${size.price})"
                    >
                    <label for="size-${size.name}" class="option-content">
                        <span class="option-name">${size.name}</span>
                        <span class="option-price">+₱${size.price.toFixed(2)}</span>
                    </label>
                </div>
            `).join('');
        }

        // Render addon options
        if (addonOptions && this.selectedProduct.addons) {
            addonOptions.innerHTML = this.selectedProduct.addons.map(addon => `
                <div class="addon-option">
                    <input 
                        type="checkbox" 
                        value="${addon.name}" 
                        id="addon-${addon.name}"
                        onchange="menuPage.toggleAddon('${addon.name}', ${addon.price})"
                    >
                    <label for="addon-${addon.name}" class="option-content">
                        <span class="option-name">${addon.name}</span>
                        <span class="option-price">+₱${addon.price.toFixed(2)}</span>
                    </label>
                </div>
            `).join('');
        }

        if (quantityDisplay) quantityDisplay.textContent = this.quantity;
        
        this.updateTotalPrice();
    }

    selectSize(sizeName, price) {
        this.selectedSize = { name: sizeName, price: price };
        this.updateTotalPrice();
    }

    toggleAddon(addonName, price) {
        const existingIndex = this.selectedAddons.findIndex(addon => addon.name === addonName);
        
        if (existingIndex >= 0) {
            this.selectedAddons.splice(existingIndex, 1);
        } else {
            this.selectedAddons.push({ name: addonName, price: price });
        }
        
        this.updateTotalPrice();
    }

    updateQuantity(change) {
        this.quantity = Math.max(1, this.quantity + change);
        const quantityDisplay = document.querySelector('.quantity-display');
        if (quantityDisplay) {
            quantityDisplay.textContent = this.quantity;
        }
        this.updateTotalPrice();
    }

    updateTotalPrice() {
        let total = this.selectedProduct.price;
        
        if (this.selectedSize) {
            total += this.selectedSize.price;
        }
        
        this.selectedAddons.forEach(addon => {
            total += addon.price;
        });
        
        total *= this.quantity;
        
        this.totalPrice = total;
        
        const totalPriceElement = document.querySelector('.total-price');
        if (totalPriceElement) {
            totalPriceElement.innerHTML = `
                <span>Total: </span>
                <span>₱${total.toFixed(2)}</span>
            `;
        }
    }

    addToCart() {
        if (!this.selectedProduct) return;

        const cartItem = {
            id: this.selectedProduct._id,
            name: this.selectedProduct.name,
            basePrice: this.selectedProduct.price,
            size: this.selectedSize,
            addons: [...this.selectedAddons],
            quantity: this.quantity,
            totalPrice: this.totalPrice,
            image: this.selectedProduct.image
        };

        this.cart.push(cartItem);
        this.saveCart();
        this.updateCartDisplay();
        this.closeModal();
        this.showCartNotification();
    }

    showModal() {
        const modal = document.querySelector('#customizationModal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    closeModal() {
        const modal = document.querySelector('#customizationModal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    }

    loadCart() {
        const cart = localStorage.getItem('cart');
        return cart ? JSON.parse(cart) : [];
    }

    saveCart() {
        localStorage.setItem('cart', JSON.stringify(this.cart));
    }

    getCartItemCount() {
        return this.cart.reduce((total, item) => total + item.quantity, 0);
    }

    updateCartDisplay() {
        const cartCount = document.querySelector('.cart-count');
        if (cartCount) {
            const count = this.getCartItemCount();
            cartCount.textContent = count;
            cartCount.style.display = count > 0 ? 'block' : 'none';
        }
    }

    createNotificationElement() {
        if (!document.querySelector('.cart-notification')) {
            const notification = document.createElement('div');
            notification.className = 'cart-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-check-circle"></i>
                    <span>Item added to cart!</span>
                </div>
            `;
            document.body.appendChild(notification);
        }
    }

    showCartNotification() {
        const notification = document.querySelector('#cartNotification');
        if (notification) {
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    }
}

// Global functions for event handlers
function toggleDropdown() {
    const dropdown = document.getElementById('dropdown-menu');
    if (dropdown) {
        dropdown.classList.toggle('show');
    }
}

function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('user');
    window.location.href = 'index.html';
}

// Initialize menu page when DOM is loaded
let menuPage;
document.addEventListener('DOMContentLoaded', () => {
    menuPage = new MenuPage();
});

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.matches('.dropdown-toggle')) {
        const dropdown = document.getElementById('dropdown-menu');
        if (dropdown && dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
        }
    }
});
